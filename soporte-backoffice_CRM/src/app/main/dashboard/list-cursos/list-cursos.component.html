<app-loader *ngIf="verModal"></app-loader>
<ng-template #courseModal let-modal>
  <app-etiquetera></app-etiquetera>
</ng-template>

<section class="container mt-5">
  <!-- Header -->
  <div class="row align-items-center mb-4">
    <div class="col-md-6">
      <h2 class="text-primary fw-bold">Cursos</h2>
    </div>
    <!-- Botón para abrir el modal -->
    <div class="col-md-6 text-md-end">
      <button class="btn btn-primary" (click)="openCourseModal()">
        <i class="fas fa-plus-circle me-1"></i> Nuevo Curso
      </button>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="row mb-3">
    <div class="col-md-6">
      <input
        type="text"
        class="form-control"
        placeholder="Buscar curso..."
        [(ngModel)]="searchTerm"
        (input)="onSearch()"
      />
    </div>
    <div class="col-md-6 text-md-end">
      <label class="d-inline-flex align-items-center">
        Mostrar
        <select class="form-control ms-2" [(ngModel)]="basicSelectedOption">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>

        cursos
      </label>
    </div>
  </div>

  <!-- DataTable -->
  <ngx-datatable
    #table
    class="bootstrap core-bootstrap"
    [rows]="filteredRows"
    [columnMode]="ColumnMode.force"
    [headerHeight]="50"
    [footerHeight]="50"
    [rowHeight]="60"
    [limit]="basicSelectedOption"
  >
    <!-- Nro Column -->
    <ngx-datatable-column name="" [width]="10" [sortable]="false">
      <ng-template ngx-datatable-cell-template let-rowIndex="rowIndex">
        {{ rowIndex + 1 }}
      </ng-template>
    </ngx-datatable-column>

    <!-- Logo Column -->
    <ngx-datatable-column name="Logo" [width]="10" [sortable]="false">
      <ng-template ngx-datatable-cell-template let-row="row">
        <img
          [src]="'http://localhost:3200/api/curso/logo/' + row.id"
          alt="Logo del Curso"
          class="rounded-circle shadow-sm border"
          style="height: 40px; width: 40px; object-fit: cover"
        />
      </ng-template>
    </ngx-datatable-column>

    <!-- Nombre del Curso Column -->
    <ngx-datatable-column name="Nombre del Curso" prop="nombre" [width]="50">
      <ng-template ngx-datatable-cell-template let-row="row">
        <span class="fw-bold text-dark">{{ row.nombre }}</span>
      </ng-template>
    </ngx-datatable-column>

    <!-- Acciones Column -->
    <ngx-datatable-column name="Acciones" [width]="30" [sortable]="false">
      <ng-template ngx-datatable-cell-template let-row="row">
        <button
          class="btn btn-outline-primary btn-sm"
          (click)="toggleModulePanel(row)"
        >
          Gestionar Módulos
        </button>

        <div *ngIf="row.showModules" class="mt-3">
          <!-- Select Box para Módulos -->
          <select
            class="form-control"
            [(ngModel)]="row.selectedModule"
            (change)="onAddModuleToCourse(row)"
          >
            <option [value]="null">Añadir nuevo módulo</option>
            <option *ngFor="let module of availableModules" [value]="module.id">
              {{ module.nombre }}
            </option>
          </select>

          <!-- Lista de Módulos Seleccionados -->
          <ul class="mt-3">
            <li
              *ngFor="let module of row.modules"
              class="d-flex align-items-center"
            >
              <span> Módulo N° {{ module.id }}: {{ module.nombre }} </span>
              <button
                class="btn btn-sm btn-warning ms-2"
                (click)="editModule(module.id)"
              >
                Editar
              </button>
              <button
                class="btn btn-sm btn-danger ms-2"
                (click)="removeModuleFromCourse(row, module.id)"
              >
                Eliminar
              </button>

              <!-- Select Box para Cláusulas -->
              <div class="ms-3">
                <select
                  class="form-control"
                  [(ngModel)]="module.selectedClausula"
                  (change)="onAddClausulaToModule(module)"
                >
                  <option [value]="null">Añadir nueva cláusula</option>
                  <option
                    *ngFor="let clausula of availableClausulas"
                    [value]="clausula.id"
                  >
                    {{ clausula.nombre }}
                  </option>
                </select>

                <!-- Lista de Cláusulas -->
                <ul class="mt-2">
                  <li
                    *ngFor="let clausula of module.clausulas"
                    class="d-flex align-items-center"
                  >
                    <span>
                      Cláusula N° {{ clausula.id }}: {{ clausula.nombre }}</span
                    >
                    <button
                      class="btn btn-sm btn-danger ms-2"
                      (click)="removeClausulaFromModule(module, clausula.id)"
                    >
                      Eliminar
                    </button>
                  </li>
                </ul>
              </div>
            </li>
          </ul>
        </div>
      </ng-template>
    </ngx-datatable-column>
  </ngx-datatable>
</section>
